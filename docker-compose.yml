services:
  volume-init:
    image: manjarolinux/base:latest
    env_file:
      - .env
    volumes:
      - ./scripts/init-volumes.sh:/init-volumes.sh:ro
      - security-tools:/mnt/security-tools
      - go-cache:/mnt/go-cache
      - shell-history:/mnt/shell-history
      - git-tools:/mnt/git-tools
      - aws-config:/mnt/aws-config
      - vscode-config:/mnt/vscode-config
      - npm-cache:/mnt/npm-cache
      - docker-config:/mnt/docker-config
      - nvim-cache:/mnt/nvim-cache
    command: ["sh", "/init-volumes.sh"]
    
  dev-env:
    depends_on:
      volume-init:
        condition: service_completed_successfully
    build:
      context: .
      args:
        - BUILD_DATE=${BUILD_DATE:-}
    image: dotfiles-dev-env
    container_name: dev-environment
    env_file:
      - .env
    user: "${DEV_USER_ID:-1001}:${DEV_GROUP_ID:-1001}"
    init: true
    healthcheck:
      test: ["CMD", "pgrep", "sshd"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
    labels:
      - "com.docker.compose.project=dotfiles"
      - "dev.environment.type=development"
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=500m
      - /run:noexec,nosuid,nodev,size=100m
    security_opt:
      - no-new-privileges:true
    ports:
      - "2222:2222"
      - "8080:8080"
      - "3000:3000"
      - "9000:9000"
    volumes:
      - ./workspace:/workspace
      - ./configs/nvim/init.lua:/home/dev/.config/nvim/init.lua:ro
      - ./configs/.zshrc:/home/dev/.zshrc:ro
      - ./configs/.tmux.conf:/home/dev/.tmux.conf:ro
      - ./configs/linux/etc/ssh/sshd_config:/etc/ssh/sshd_config:ro
      - ./configs/linux/etc/sysctl.d/99-optimized.conf:/etc/sysctl.d/99-optimized.conf:ro
      - ./configs/linux/etc/profile.d:/etc/profile.d:ro
      - ./configs/linux/etc/locale.conf:/etc/locale.conf:ro
      - ./configs/linux/etc/timezone:/etc/timezone:ro
      - ./configs/linux/etc/security:/etc/security:ro

      - security-tools:/home/dev/.security
      - go-cache:/home/dev/.go-cache
      - shell-history:/home/dev/.shell_history
      - git-tools:/home/dev/.git_tools
      - aws-config:/home/dev/.aws
      - vscode-config:/home/dev/.vscode
      - npm-cache:/home/dev/.npm
      - nvim-cache:/home/dev/.local/share/nvim
      
      - /var/run/docker.sock:/var/run/docker.sock
      - docker-config:/home/dev/.docker
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks:
      - dev-network

volumes:
  go-cache:
  shell-history:
  git-tools:
  security-tools:
  aws-config:
  vscode-config:
  npm-cache:
  docker-config:
  nvim-cache:

networks:
  dev-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.host_binding_ipv4: "0.0.0.0"
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
